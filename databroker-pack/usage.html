

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Usage &mdash; databroker-pack 0.1.4.post33+ga27dbf3 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reference" href="reference.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> databroker-pack
          

          
          </a>

          
            
            
              <div class="version">
                0.1.4.post33+ga27dbf3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#packing-a-catalog">Packing a Catalog</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#unpacking-a-packed-catalog">Unpacking a Packed Catalog</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#option-1-unpacking-in-place">Option 1: Unpacking “in place”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#option-2-unpacking-into-mongodb">Option 2: Unpacking into MongoDB</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-an-unpacked-catalog">Using an Unpacked Catalog</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-without-unpacking">Use Without Unpacking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="min_versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">databroker-pack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Usage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<p>There is a Python interface, but most users will find the commandline tool
suitable for their needs.</p>
<div class="section" id="packing-a-catalog">
<h2>Packing a Catalog<a class="headerlink" href="#packing-a-catalog" title="Permalink to this headline">¶</a></h2>
<p>For the command line tool <code class="docutils literal notranslate"><span class="pre">databroker-pack</span></code> you must provide:</p>
<ul class="simple">
<li><p>The name of the source catalog</p></li>
<li><p>The name of the target directory</p></li>
<li><p>Which Runs in the Catalog to pack: either <code class="docutils literal notranslate"><span class="pre">--all</span></code>, a query such as a time
window, or a list of <code class="docutils literal notranslate"><span class="pre">--uids</span></code>.</p></li>
</ul>
<p>The result is a directory, which you can optionally compress and transfer by
any convenient means.</p>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>List the available options for <code class="docutils literal notranslate"><span class="pre">CATALOG</span></code> and exit.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack --list-catalogs
&lt;list of catalog names&gt;
</pre></div>
</div>
<p>Export every Run in the Catalog into a self-contained directory with Documents
and any external files (e.g. large array data from detectors).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG --all DIRECTORY --copy-external
</pre></div>
</div>
<p>Or, read the data from the external files and place it directly in the
documents. This may make data access slower and less flexible, but it removes
the requiment for the recipient to install any special I/O code to deal with
detector formats.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG --all DIRECTORY --fill-external
</pre></div>
</div>
<p>Or, omit the external files and transfer them separately. The <code class="docutils literal notranslate"><span class="pre">DIRECTORY</span></code>
will still contain text file <em>manifests</em> listing the locations of the external
files on the source system, suitable for feeding to tools like <code class="docutils literal notranslate"><span class="pre">rsync</span></code> or
<code class="docutils literal notranslate"><span class="pre">globus</span> <span class="pre">transfer</span> <span class="pre">--batch</span></code>. This is like the recommended approach for very
large transfers.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG --all DIRECTORY
</pre></div>
</div>
<p>Export Runs from a range of time.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG -q <span class="s2">&quot;TimeRange(since=&#39;2020&#39;)&quot;</span> DIRECTORY
databroker-pack CATALOG -q <span class="s2">&quot;TimeRange(since=&#39;2020&#39;, until=&#39;2020-03-01)&quot;</span> DIRECTORY
</pre></div>
</div>
<p>Export Runs from a range of time with a certain plan_name.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG -q <span class="s2">&quot;TimeRange(since=&#39;2020&#39;)&quot;</span> -q <span class="s2">&quot;{&#39;plan_name&#39;: &#39;count&#39;}&quot;</span> DIRECTORY
</pre></div>
</div>
<p>Export a specific Run by its scan_id</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG -q <span class="s2">&quot;{&#39;scan_id&#39;: 126360}&quot;</span> DIRECTORY
</pre></div>
</div>
<p>Export specific Runs given by their Run Start UID (or the first several
characters) entered at the command prompt…</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG --uids -
3c93c54e
47587fa8
ebad8c01
&lt;Ctrl D&gt;
</pre></div>
</div>
<p>…or read from a file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack CATALOG --uids uids_to_pack.txt
</pre></div>
</div>
</div>
</div>
<div class="section" id="unpacking-a-packed-catalog">
<h2>Unpacking a Packed Catalog<a class="headerlink" href="#unpacking-a-packed-catalog" title="Permalink to this headline">¶</a></h2>
<p>There are two ways to do this:</p>
<dl class="simple">
<dt># <code class="docutils literal notranslate"><span class="pre">inplace</span></code> — Run databroker on top of the files as they are. This is</dt><dd><p>recommended only for smalls exports (tens of Runs) when a Mongo database is
not available.</p>
</dd>
<dt># <code class="docutils literal notranslate"><span class="pre">mongo_normalized</span></code> — Copy the documents from the packed directory into</dt><dd><p>MongoDB, and point databroker at MongoDB.</p>
</dd>
</dl>
<div class="section" id="option-1-unpacking-in-place">
<h3>Option 1: Unpacking “in place”<a class="headerlink" href="#option-1-unpacking-in-place" title="Permalink to this headline">¶</a></h3>
<p>Use <code class="docutils literal notranslate"><span class="pre">databroker-unpack</span></code> to make <code class="docutils literal notranslate"><span class="pre">DIRECTORY</span></code> automatically discoverable by
databroker. You must specify a <code class="docutils literal notranslate"><span class="pre">NAME</span></code> to give the catalog.</p>
<p>If the name already exists, the catalog will be updated to include content
from the pre-existing location(s) and the new one. If you want to ensure that
this catalog name is unique, prohibiting automatic merging, use the flag
<code class="docutils literal notranslate"><span class="pre">--no-merge</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-unpack inplace DIRECTORY NAME
</pre></div>
</div>
<p>For example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-unpack inplace path/to/directory_from_pack my_data
</pre></div>
</div>
<p>It is important not to move the directory after you do this.</p>
</div>
<div class="section" id="option-2-unpacking-into-mongodb">
<h3>Option 2: Unpacking into MongoDB<a class="headerlink" href="#option-2-unpacking-into-mongodb" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you need to install MongoDB, we refer you to the
<a class="reference external" href="https://docs.mongodb.com/manual/installation/#mongodb-community-edition-installation-tutorials">official guides</a>
for installing the MongoDB Community Edition.</p>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">databroker-unpack</span></code> to copy the data from the documents (stored in the
pack directory as <code class="docutils literal notranslate"><span class="pre">.msgpack</span></code> or <code class="docutils literal notranslate"><span class="pre">.jsonl</span></code> files) into MongoDB. Any external
files (e.g. large detector images stored separately) will be left where they
are and must done be deleted or moved once <code class="docutils literal notranslate"><span class="pre">databroker-unpack</span></code> has been run.</p>
<p>If the name already exists, the catalog will be updated to include content
from the pre-existing location(s) and the new one. If you want to ensure that
this catalog name is unique, prohibiting automatic merging, use the flag
<code class="docutils literal notranslate"><span class="pre">--no-merge</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-unpack mongo_normalized DIRECTORY NAME
</pre></div>
</div>
<p>For example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-unpack mongo_normalized path/to/directory_from_pack my_data
</pre></div>
</div>
<p>By default this look for an unauthenticated MongoDB running on localhost on
the standard port. A custom MongoDB URI amy be specified using the option
<code class="docutils literal notranslate"><span class="pre">--mongo-uri</span> <span class="pre">MONGO_URI</span></code>. See <code class="docutils literal notranslate"><span class="pre">databroker-unpack</span> <span class="pre">--help</span></code> for more
information.</p>
</div>
</div>
<div class="section" id="using-an-unpacked-catalog">
<h2>Using an Unpacked Catalog<a class="headerlink" href="#using-an-unpacked-catalog" title="Permalink to this headline">¶</a></h2>
<p>Then the newly “unpacked” catalog (e.g. <code class="docutils literal notranslate"><span class="pre">my_data</span></code>) will show in</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>databroker-pack --list-catalogs
</pre></div>
</div>
<p>and can be accessed like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">databroker</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">databroker</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;my_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>This catalog, <code class="docutils literal notranslate"><span class="pre">db</span></code>, contains the packed Runs, which can be accessed in the
usual way like <code class="docutils literal notranslate"><span class="pre">db['&lt;uid&gt;']</span></code>, <code class="docutils literal notranslate"><span class="pre">db[&lt;scan_id&gt;]</span></code>, <code class="docutils literal notranslate"><span class="pre">db[-1]</span></code>, or fully
enumerated (unwise if the Catalog is huge) <code class="docutils literal notranslate"><span class="pre">list(db)</span></code>.</p>
</div>
<div class="section" id="use-without-unpacking">
<h2>Use Without Unpacking<a class="headerlink" href="#use-without-unpacking" title="Permalink to this headline">¶</a></h2>
<p>Alternatively, you can run databroker on top of a directory generated by
<code class="docutils literal notranslate"><span class="pre">databroker-pack</span></code> without any unpacking step.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Currently, the following only works if the packed directory is in its
original location. In a future release, it will also work if the directory
has been moved or copied to a different location.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">intake</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_catalog</span><span class="p">(</span><span class="s1">&#39;DIRECTORY/catalog.yml&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>replacing <code class="docutils literal notranslate"><span class="pre">DIRECTORY</span></code> with the path to the directory generated by
<code class="docutils literal notranslate"><span class="pre">databroker-pack</span></code>. This will contain a catalog named <code class="docutils literal notranslate"><span class="pre">'packed_catalog'</span></code>,
which you can open like so.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;packed_catalog&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="reference.html" class="btn btn-neutral float-right" title="Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Bluesky Collaboration

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>