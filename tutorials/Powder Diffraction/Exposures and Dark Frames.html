

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Exposures and Dark Frames &mdash; Bluesky Tutorials  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Powder Diffraction" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Bluesky Tutorials
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Basic Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Hello Python and Jupyter.html">Hello Python and Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Hello Bluesky.html">Hello Bluesky: Reading detectors and scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Access Saved Data.html">Access Saved Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Let Us Do the Bookkeeping For You.html">Let Us Do the Bookkeeping For You</a></li>
</ul>
<p class="caption"><span class="caption-text">For Controls Engineers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Epics Signal.html">Epics Signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Anatomy of a Device.html">Anatomy of a Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Flyer Basics.html">Flyer Basics</a></li>
</ul>
<p class="caption"><span class="caption-text">For Scientists</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Live Nonlinear Fitting.html">Live Nonlinear Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Process Tabular Data with Pandas.html">Process Tabular Data with Pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Slice and Interpolate Image Data.html">Slice and Interpolate Image Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Higher Dimensional Data.html">Higher Dimensional Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Multi-dimensional Coordinates.html">Multi-dimensional Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Export data to files with Suitcase.html">Export data to files with Suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">Applied Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../X-ray Absorption Fine Structure/index.html">X-ray Absorption Fine Structure</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Powder Diffraction</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Exposures and Dark Frames</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Simulation-intro-text">Simulation intro text</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Dark-image-introduction">Dark image introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Integrate-to-get-pattern">Integrate to get pattern</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Bluesky-plan-to-gather-light/dark-automatically">Bluesky plan to gather light/dark automatically</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Part-B:-Managing-multiple-samples.">Part B: Managing multiple samples.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Part-C-:-More-samples,-more-problems.">Part C : More samples, more problems.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Why-does-our-average-look-so-bad?-Huge-background.-Let’s-look-at-individual-runs.">Why does our average look so bad? Huge background. Let’s look at individual runs.</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Concluding-remarks!">Concluding remarks!</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bluesky Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Powder Diffraction</a> &raquo;</li>
        
      <li>Exposures and Dark Frames</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Powder Diffraction/Exposures and Dark Frames.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You can run this notebook in a <a class="reference external" href="https://mybinder.org/v2/gh/bluesky/tutorials/master?urlpath=lab/tree/Powder%20Diffraction/Exposures%20and%20Dark%20Frames.ipynb">live session</a> <a class="reference external" href="https://mybinder.org/v2/gh/bluesky/tutorials/master?urlpath=lab/tree/Powder%20Diffraction/Exposures%20and%20Dark%20Frames.ipynb"><img alt="Binder" src="https://mybinder.org/badge.svg" /></a>
or view it <a class="reference external" href="https://nbviewer.jupyter.org/github/bluesky/tutorials/blob/master/Powder%20Diffraction/Exposures%20and%20Dark%20Frames.ipynb">on nbviewer</a>
or <a class="reference external" href="https://github.com/bluesky/tutorials/blob/master/Powder%20Diffraction/Exposures%20and%20Dark%20Frames.ipynb">GitHub</a>.</p>
</div>
<div class="section" id="Exposures-and-Dark-Frames">
<h1>Exposures and Dark Frames<a class="headerlink" href="#Exposures-and-Dark-Frames" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">bluesky_tutorial_utils</span> <span class="kn">import</span> <span class="n">setup_data_saving</span>
<span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">RunEngine</span>
<span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="kn">import</span> <span class="n">count</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">simple_integration</span>

<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">()</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">setup_data_saving</span><span class="p">(</span><span class="n">RE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">simulated_hardware</span> <span class="kn">import</span> <span class="n">detector</span><span class="p">,</span> <span class="n">load_sample</span><span class="p">,</span> <span class="n">unload_sample</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">history_reset</span><span class="p">,</span> <span class="n">sim_sleep</span>
<span class="kn">from</span> <span class="nn">simulated_hardware</span> <span class="kn">import</span> <span class="n">_history</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#we can eventually hide some of these in another file</span>

<span class="k">def</span> <span class="nf">dark_light_subtract</span><span class="p">(</span><span class="n">sample_num</span><span class="p">,</span> <span class="n">num_lights</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1">#close shutter if not already closed</span>
    <span class="k">yield from</span> <span class="n">light</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#move to desired sample</span>
    <span class="k">yield from</span> <span class="n">load_sample</span><span class="p">(</span><span class="n">sample_num</span><span class="p">)</span>

    <span class="c1">#take dark image</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">detector</span><span class="p">])</span>

    <span class="c1">#open shutter</span>
    <span class="k">yield from</span> <span class="n">light</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#take light image</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lights</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">detector</span><span class="p">])</span>

    <span class="c1">#close shutter to be nice to detector</span>
    <span class="k">yield from</span> <span class="n">light</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">num_lights</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">return_light</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_dark</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="c1">#assuming pair is tuple</span>
    <span class="n">my_dark</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">detector_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">return_dark</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simple_integration</span><span class="p">(</span><span class="n">my_dark</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">301</span><span class="p">)</span>

    <span class="n">dark_subbed_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_lights</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">this_light</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">detector_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">return_light</span><span class="p">:</span>
            <span class="n">dark_subbed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_light</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dark_subbed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_light</span> <span class="o">-</span> <span class="n">my_dark</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_lights</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simple_integration</span><span class="p">(</span><span class="n">dark_subbed_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num_bins</span><span class="o">=</span><span class="mi">301</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># more than one</span>
        <span class="n">int_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dark_subbed_list</span><span class="p">)):</span>
            <span class="n">int_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simple_integration</span><span class="p">(</span><span class="n">dark_subbed_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">num_bins</span><span class="o">=</span><span class="mi">301</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">int_list</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="k">def</span> <span class="nf">make_ideal_data</span><span class="p">(</span><span class="n">sample_num</span><span class="p">):</span>
    <span class="n">_history</span><span class="p">[</span><span class="s1">&#39;perfect_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">perfect_pair</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">dark_light_subtract</span><span class="p">(</span><span class="n">sample_num</span><span class="p">))</span>

    <span class="n">this_light</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="n">perfect_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">detector_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">perfect_int</span> <span class="o">=</span> <span class="n">simple_integration</span><span class="p">(</span><span class="n">this_light</span><span class="p">,</span><span class="n">num_bins</span><span class="o">=</span><span class="mi">301</span><span class="p">)</span>

    <span class="n">_history</span><span class="p">[</span><span class="s1">&#39;perfect_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">perfect_int</span>

<span class="k">def</span> <span class="nf">normalized_residual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ideal</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">ideal</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalized_residual_sqrd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ideal</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">ideal</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">retrieve_im</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">catalog</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">detector_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_history</span><span class="p">[</span><span class="s1">&#39;action_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>

<span class="n">perfect_int1</span> <span class="o">=</span> <span class="n">make_ideal_data</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">perfect_int2</span> <span class="o">=</span> <span class="n">make_ideal_data</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">perfect_int3</span> <span class="o">=</span> <span class="n">make_ideal_data</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">perfect_int4</span> <span class="o">=</span> <span class="n">make_ideal_data</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
something empty
</pre></div></div>
</div>
<div class="section" id="Simulation-intro-text">
<h2>Simulation intro text<a class="headerlink" href="#Simulation-intro-text" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#load sample</span>
<span class="n">RE</span><span class="p">(</span><span class="n">load_sample</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1">#turn on light</span>
<span class="n">RE</span><span class="p">(</span><span class="n">light</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>

<span class="c1">#count</span>
<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">detector</span><span class="p">]))</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;50ead062-0cfd-44f2-8ec5-1eb9a25c591b&#39;,)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#retrieve image from databroker</span>
<span class="n">my_im</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">detector_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">my_im</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.colorbar.Colorbar at 0x7f2338264a20&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_8_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_8_1.png" />
</div>
</div>
<div class="section" id="Dark-image-introduction">
<h3>Dark image introduction<a class="headerlink" href="#Dark-image-introduction" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#we started at t=0, so we&#39;ll just go before then to measure the dark.</span>
<span class="c1">#time_travel(-1)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">light</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>

<span class="n">sim_sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">detector</span><span class="p">]))</span>

<span class="n">my_dark</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">detector_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sleeping for 10
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">my_dark</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7f232eb2e630&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_11_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_11_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">my_im</span> <span class="o">-</span> <span class="n">my_dark</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7f232eb10278&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_12_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_12_1.png" />
</div>
</div>
</div>
<div class="section" id="Integrate-to-get-pattern">
<h3>Integrate to get pattern<a class="headerlink" href="#Integrate-to-get-pattern" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">intensity</span> <span class="o">=</span> <span class="n">simple_integration</span><span class="p">(</span><span class="n">my_im</span> <span class="o">-</span> <span class="n">my_dark</span><span class="p">,</span><span class="n">num_bins</span><span class="o">=</span><span class="mi">301</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&#39;measured&#39;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f232eab59b0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_14_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_14_1.png" />
</div>
</div>
</div>
<div class="section" id="Bluesky-plan-to-gather-light/dark-automatically">
<h3>Bluesky plan to gather light/dark automatically<a class="headerlink" href="#Bluesky-plan-to-gather-light/dark-automatically" title="Permalink to this headline">¶</a></h3>
<div class="section" id="Demonstrate-how-to-make-a-simple-plan-using-bluesky-(unless-we-have-one-already-defined-at-this-point).">
<h4>Demonstrate how to make a simple plan using bluesky (unless we have one already defined at this point).<a class="headerlink" href="#Demonstrate-how-to-make-a-simple-plan-using-bluesky-(unless-we-have-one-already-defined-at-this-point)." title="Permalink to this headline">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">dark_light_subtract</span><span class="p">(</span><span class="n">sample_num</span><span class="p">,</span> <span class="n">num_lights</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">uids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#close shutter if not already closed</span>
    <span class="k">yield from</span> <span class="n">light</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#move to desired sample</span>
    <span class="k">yield from</span> <span class="n">load_sample</span><span class="p">(</span><span class="n">sample_num</span><span class="p">)</span>

    <span class="c1">#take dark image</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">detector</span><span class="p">])</span>
    <span class="n">uids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

    <span class="c1">#open shutter</span>
    <span class="k">yield from</span> <span class="n">light</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#take light image</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lights</span><span class="p">):</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">detector</span><span class="p">])</span>
        <span class="n">uids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

    <span class="c1">#close shutter to be nice to detector</span>
    <span class="k">yield from</span> <span class="n">light</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uids</span>
</pre></div>
</div>
</div>
<p>Run engine returns uids</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">uids</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">dark_light_subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">uids</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;85d86774-b549-4160-9bbd-cdb8001c3162&#39;,
 &#39;4c99fb1b-ee63-40b1-a1db-25e9124425c3&#39;)
</pre></div></div>
</div>
</div>
<div class="section" id="At-beamline,-we-have-autoreduction.-Here,-we-wrote-a-helper-function-called-“process_data”-which-will-return-your-integrated-intensity.">
<h4>At beamline, we have autoreduction. Here, we wrote a helper function called “process_data” which will return your integrated intensity.<a class="headerlink" href="#At-beamline,-we-have-autoreduction.-Here,-we-wrote-a-helper-function-called-“process_data”-which-will-return-your-integrated-intensity." title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">this_intensity</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_intensity</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7f232e210c50&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_21_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_21_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Part-B:-Managing-multiple-samples.">
<h3>Part B: Managing multiple samples.<a class="headerlink" href="#Part-B:-Managing-multiple-samples." title="Permalink to this headline">¶</a></h3>
<div class="section" id="How-to-Turn-on-/-Turn-off-light,-and-how-to-switch-between-samples.">
<h4>How to Turn-on / Turn-off light, and how to switch between samples.<a class="headerlink" href="#How-to-Turn-on-/-Turn-off-light,-and-how-to-switch-between-samples." title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#history_reset()</span>

<span class="n">RE</span><span class="p">(</span><span class="n">light</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>

<span class="n">RE</span><span class="p">(</span><span class="n">load_sample</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">RE</span><span class="p">(</span><span class="n">load_sample</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="n">RE</span><span class="p">(</span><span class="n">load_sample</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>


</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
()
</pre></div></div>
</div>
</div>
<div class="section" id="Explain-that-much-like-many-real-detectors,-our-simulated-detector-has-some-degree-of-memory.-Burn-in-effects-are-possible,-as-are-after-image.">
<h4>Explain that much like many real detectors, our simulated detector has some degree of memory. Burn-in effects are possible, as are after-image.<a class="headerlink" href="#Explain-that-much-like-many-real-detectors,-our-simulated-detector-has-some-degree-of-memory.-Burn-in-effects-are-possible,-as-are-after-image." title="Permalink to this headline">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">uids</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">dark_light_subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">my_light</span> <span class="o">=</span> <span class="n">retrieve_im</span><span class="p">(</span><span class="n">uids</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">my_dark</span> <span class="o">=</span> <span class="n">retrieve_im</span><span class="p">(</span><span class="n">uids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">my_light</span> <span class="o">-</span> <span class="n">my_dark</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7f232e122da0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_26_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_26_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">uids</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span><span class="n">return_light</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span><span class="n">return_dark</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7f232e0c2588&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_27_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_27_1.png" />
</div>
</div>
</div>
<div class="section" id="We-see-features-in-the-dark-(peaks),-that-tell-us-our-dark-is-kind-of-no-good.">
<h4>We see features in the dark (peaks), that tell us our dark is kind of no-good.<a class="headerlink" href="#We-see-features-in-the-dark-(peaks),-that-tell-us-our-dark-is-kind-of-no-good." title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sim_sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">uids</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">dark_light_subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sleeping for 100
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">uids</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span><span class="n">return_light</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span><span class="n">return_dark</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7f232dfaf0f0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_30_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_30_1.png" />
</div>
</div>
<div class="section" id="Much-cleaner-looking-dark,-no-outstanding-peaks.-Clearly,-managment-of-darks-is-an-important-aspect-of-diffraction-measurements-(at-least-on-these-detectors).">
<h5>Much cleaner looking dark, no outstanding peaks. Clearly, managment of darks is an important aspect of diffraction measurements (at least on these detectors).<a class="headerlink" href="#Much-cleaner-looking-dark,-no-outstanding-peaks.-Clearly,-managment-of-darks-is-an-important-aspect-of-diffraction-measurements-(at-least-on-these-detectors)." title="Permalink to this headline">¶</a></h5>
</div>
</div>
</div>
<div class="section" id="Part-C-:-More-samples,-more-problems.">
<h3>Part C : More samples, more problems.<a class="headerlink" href="#Part-C-:-More-samples,-more-problems." title="Permalink to this headline">¶</a></h3>
<div class="section" id="In-a-real-experement,-you-often-switch-between-samples,-and-they-don’t-all-scatter-the-same.-We-often-measure-multiple-times-on-a-single-sample-and-sum-the-results-to-improve-statistics.">
<h4>In a real experement, you often switch between samples, and they don’t all scatter the same. We often measure multiple times on a single sample and sum the results to improve statistics.<a class="headerlink" href="#In-a-real-experement,-you-often-switch-between-samples,-and-they-don’t-all-scatter-the-same.-We-often-measure-multiple-times-on-a-single-sample-and-sum-the-results-to-improve-statistics." title="Permalink to this headline">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#change to noisy detector</span>

<span class="n">_history</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">_history</span><span class="p">[</span><span class="s1">&#39;action_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">20.0</span> <span class="c1"># 1.0</span>
<span class="n">_history</span><span class="p">[</span><span class="s1">&#39;panel_wl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span> <span class="c1"># 8000</span>
</pre></div>
</div>
</div>
<p>Look at single scan vs. perfect data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">uid</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">dark_light_subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perfect_int1</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7f232df74cf8&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_35_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_35_1.png" />
</div>
</div>
<p>Run multiple scans on single sample (single dark)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">uids1</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">dark_light_subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_lights</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">reduced_data1</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">uids1</span><span class="p">,</span> <span class="n">num_lights</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">uids1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
</div>
<p>Plot vs. Perfect data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perfect_int1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reduced_data1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">));</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_40_0.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_40_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Why-does-our-average-look-so-bad?-Huge-background.-Let’s-look-at-individual-runs.">
<h3>Why does our average look so bad? Huge background. Let’s look at individual runs.<a class="headerlink" href="#Why-does-our-average-look-so-bad?-Huge-background.-Let’s-look-at-individual-runs." title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reduced_data1</span><span class="p">);</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_42_0.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_42_0.png" />
</div>
</div>
<div class="section" id="We-see-there-is-a-slowly-rising-background,-which-is-why-our-average-was-corrupted.-What-is-happening?">
<h4>We see there is a slowly rising background, which is why our average was corrupted. What is happening?<a class="headerlink" href="#We-see-there-is-a-slowly-rising-background,-which-is-why-our-average-was-corrupted.-What-is-happening?" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="Just-like-a-real-detector,-our-simulated-detector-has-a-slowly-varying-background.-We-need-to-refresh-our-dark-more-frequently-to-account-for-this.">
<h4>Just like a real detector, our simulated detector has a slowly varying background. We need to refresh our dark more frequently to account for this.<a class="headerlink" href="#Just-like-a-real-detector,-our-simulated-detector-has-a-slowly-varying-background.-We-need-to-refresh-our-dark-more-frequently-to-account-for-this." title="Permalink to this headline">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<p>Here is a crude plan (RE in a loop) which has a sleep in between our shots, each of which has it’s own dark.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history_reset</span><span class="p">()</span>
<span class="n">new_int_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">def</span> <span class="nf">custom_plan</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">this_pair</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">dark_light_subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">new_int_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_data</span><span class="p">(</span><span class="n">this_pair</span><span class="p">))</span>
        <span class="n">sim_sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">custom_plan</span><span class="p">())</span>

<span class="n">new_int_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_int_list</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
something empty
sleeping for 60
sleeping for 60
sleeping for 60
sleeping for 60
sleeping for 60
sleeping for 60
sleeping for 60
sleeping for 60
sleeping for 60
sleeping for 60
</pre></div></div>
</div>
<p>Now compare this to the ideal data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perfect_int1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_int_list</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_int_list</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">perfect_int1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7f232dfb5a90&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_48_1.png" src="../_images/Powder_Diffraction_Exposures_and_Dark_Frames_48_1.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="Concluding-remarks!">
<h2>Concluding remarks!<a class="headerlink" href="#Concluding-remarks!" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Powder Diffraction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Bluesky Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>