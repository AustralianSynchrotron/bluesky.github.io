

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Flyer Basics &mdash; Bluesky Tutorials  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Process Tabular Data with Pandas" href="Process Tabular Data with Pandas.html" />
    <link rel="prev" title="Epics Signal" href="Epics Signal.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Bluesky Tutorials
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Basic Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Hello Python and Jupyter.html">Hello Python and Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hello Bluesky.html">Hello Bluesky: Reading detectors and scanning</a></li>
</ul>
<p class="caption"><span class="caption-text">For Controls Engineers</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Epics Signal.html">Epics Signal</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Flyer Basics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Python-imports-and-definitions">Python imports and definitions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Bare-Minimum-Requirements-for-a-Flyer">Bare Minimum Requirements for a Flyer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Flyer-:-a-starting-template">Flyer : a starting template</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Diagnostics">Diagnostics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#First-working-Flyer---trivial-data">First working Flyer - trivial data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Flyer-that-“collects”-1-D-array-data">Flyer that “collects” 1-D array data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">For Scientists</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Process Tabular Data with Pandas.html">Process Tabular Data with Pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="Slice and Interpolate Image Data.html">Slice and Interpolate Image Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Higher Dimensional Data.html">Higher Dimensional Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Multi-dimensional Coordinates.html">Multi-dimensional Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="Export data to files with Suitcase.html">Export data to files with Suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">Applied Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="X-ray Absorption Fine Structure/index.html">X-ray Absorption Fine Structure</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Bluesky Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Flyer Basics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Flyer Basics.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You can run this notebook in a <a class="reference external" href="https://mybinder.org/v2/gh/bluesky/tutorials/master?urlpath=lab/tree/Flyer%20Basics.ipynb">live session</a> <a class="reference external" href="https://mybinder.org/v2/gh/bluesky/tutorials/master?urlpath=lab/tree/Flyer%20Basics.ipynb"><img alt="Binder" src="https://mybinder.org/badge.svg" /></a>
or view it <a class="reference external" href="https://nbviewer.jupyter.org/github/bluesky/tutorials/blob/master/Flyer%20Basics.ipynb">on nbviewer</a>
or <a class="reference external" href="https://github.com/bluesky/tutorials/blob/master/Flyer%20Basics.ipynb">GitHub</a>.</p>
</div>
<div class="section" id="Flyer-Basics">
<h1>Flyer Basics<a class="headerlink" href="#Flyer-Basics" title="Permalink to this headline">¶</a></h1>
<p>We want to understand how to build a <em>Flyer</em> in “Bluesky” to support various types of fly scans and remote data loggers. The data about Flyers is spread about the standard documentation. We need some clarity and a few examples that build complexity incrementally.</p>
<p>The basic notion of a Flyer is that it directs an <em>external controller</em> (we’ll call it the <em>controller</em> here) to perform some data collection process. Usually, a <em>controller</em> is used to collect data at rates beyond the capabilities of Bluesky plans and the RunEngine. Examples could be waveforms from a storage oscilloscope or a continuous motion scan of a diffractometer.</p>
<p>This notebook will show the basic requirements for a Flyer and build a simple working example you can use a template for your own work. (Our inspiration to create this <a class="reference external" href="https://github.com/prjemian/ipython_mintvm/issues/3#issuecomment-385058577">basic flyer tutorial</a> was the goal of operating various fly scans at the APS, such as the <a class="reference external" href="https://github.com/APS-USAXS/ipython-usaxs/issues/3">USAXS fly scan</a>, from Bluesky. The examples we found before we started this project quickly became too
instrument-specific to serve as tutorials.)</p>
<div class="section" id="Python-imports-and-definitions">
<h2>Python imports and definitions<a class="headerlink" href="#Python-imports-and-definitions" title="Permalink to this headline">¶</a></h2>
<p>Here are the full set of packages to imported. The first block are Python standard packages, then come the ophyd, Bluesky, and databroker packages. Just the parts we plan on using here. Since this is also a tutorial, we will not rename imports or use other such shortcuts in the documentation (the online code has some shortcuts).</p>
<ul class="simple">
<li><p>Create a logger instance in case we want to investigate internal details as our code runs.</p></li>
<li><p>Create an instance of the Bluesky RunEngine.</p></li>
<li><p>Create an instance of the databroker using <code class="docutils literal notranslate"><span class="pre">`databroker.temp()</span></code> &lt;<a class="reference external" href="https://nsls-ii.github.io/databroker/v1/api.html">https://nsls-ii.github.io/databroker/v1/api.html</a>&gt;`__, establishing a temporary, disposable yet fully-functional databroker for just this tutorial session.</p></li>
<li><p>Subscribe that databroker instance to the RunEngine so it receives the document stream each time we run a plan.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">ophyd</span>
<span class="kn">import</span> <span class="nn">bluesky</span>
<span class="kn">import</span> <span class="nn">bluesky.plans</span>
<span class="kn">import</span> <span class="nn">databroker</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">RE</span> <span class="o">=</span> <span class="n">bluesky</span><span class="o">.</span><span class="n">RunEngine</span><span class="p">({})</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">databroker</span><span class="o">.</span><span class="n">temp</span><span class="p">()</span>
<span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0
</pre></div></div>
</div>
<div class="section" id="Bare-Minimum-Requirements-for-a-Flyer">
<h3>Bare Minimum Requirements for a Flyer<a class="headerlink" href="#Bare-Minimum-Requirements-for-a-Flyer" title="Permalink to this headline">¶</a></h3>
<p>In Bluesky, a <a class="reference external" href="http://nsls-ii.github.io/bluesky/async.html?highlight=flyer#flying">Flyer</a> is an <code class="docutils literal notranslate"><span class="pre">`ophyd.Device</span></code> &lt;<a class="reference external" href="http://nsls-ii.github.io/ophyd/device-overview.html">http://nsls-ii.github.io/ophyd/device-overview.html</a>&gt;`__ that meets the <a class="reference external" href="http://nsls-ii.github.io/ophyd/architecture.html#fly-able-interface">Fly-able interface</a>, which has three methods:</p>
<ol class="arabic simple">
<li><p>Kickoff - begin accumulating data</p></li>
<li><p>Complete - Bluesky tells the Flyer that Bluesky is ready to receive data</p></li>
<li><p>Collect - the device provides the data to Bluesky</p></li>
</ol>
<p>The first two methods <a class="reference external" href="http://nsls-ii.github.io/bluesky/hardware.html#kickoff">must return</a> an instance of <code class="docutils literal notranslate"><span class="pre">`ophyd.status.Status</span></code> &lt;<a class="reference external" href="http://nsls-ii.github.io/ophyd/generated/ophyd.status.Status.html">http://nsls-ii.github.io/ophyd/generated/ophyd.status.Status.html</a>&gt;`__ (a.k.a. a <em>status</em> object). For our code, we choose a specialized version of <code class="docutils literal notranslate"><span class="pre">Status()</span></code>, the <code class="docutils literal notranslate"><span class="pre">`DeviceStatus()</span></code> &lt;<a class="reference external" href="http://nsls-ii.github.io/ophyd/generated/ophyd.status.DeviceStatus.html">http://nsls-ii.github.io/ophyd/generated/ophyd.status.DeviceStatus.html</a>&gt;`__ object, based on the <a class="reference external" href="https://github.com/NSLS-II/tutorial-docker/pull/7#discussion_r185054364">explanation provided in
discussion</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">collect()</span></code> method requires a companion <code class="docutils literal notranslate"><span class="pre">describe_collect()</span></code> that informs the RunEngine what kind of data to expect from <code class="docutils literal notranslate"><span class="pre">collect()</span></code>. If no timestamp information is provided from the <em>controller</em>, then do as we show here and use the workstation’s clock to provide a timestamp for the event.</p>
<p>This example (which does absolutely nothing) meets the bare minimum requirement.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">BareMinimumFlyer</span><span class="p">(</span><span class="n">ophyd</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kickoff_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">kickoff_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kickoff_status</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">complete_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">complete_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">complete_status</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:{},</span> <span class="s1">&#39;timestamps&#39;</span><span class="p">:{},</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">describe_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{}}</span>


<span class="n">flyer</span> <span class="o">=</span> <span class="n">BareMinimumFlyer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;flyer&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">flyer</span><span class="o">.</span><span class="n">complete</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flyer</span><span class="o">.</span><span class="n">collect</span><span class="p">()))</span>

<span class="c1"># if this next step succeeds, it&#39;s proof that we did this right!</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bluesky</span><span class="o">.</span><span class="n">plans</span><span class="o">.</span><span class="n">fly</span><span class="p">([</span><span class="n">flyer</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
DeviceStatus(device=flyer, done=False, success=False)
[{&#39;data&#39;: {}, &#39;timestamps&#39;: {}, &#39;time&#39;: 1589576343.7303588}]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/travis/virtualenv/python3.7.1/lib/python3.7/site-packages/event_model/__init__.py:170: UserWarning: The document type &#39;bulk_events&#39; has been deprecated in favor of &#39;event_page&#39;, whose structure is a transpose of &#39;bulk_events&#39;.
  &#34;The document type &#39;bulk_events&#39; has been deprecated in favor of &#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;63181aaa-eb7c-4d4c-a843-7a9221c120e7&#39;,)
</pre></div></div>
</div>
<p>Only two <code class="docutils literal notranslate"><span class="pre">documents</span></code> were emitted from the <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code>: <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code> since we generated no data content.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">documents</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;start&#39;,
  {&#39;uid&#39;: &#39;63181aaa-eb7c-4d4c-a843-7a9221c120e7&#39;,
   &#39;time&#39;: 1589576343.731203,
   &#39;versions&#39;: {&#39;ophyd&#39;: &#39;1.5.1b1&#39;, &#39;bluesky&#39;: &#39;1.6.1&#39;},
   &#39;scan_id&#39;: 1,
   &#39;plan_type&#39;: &#39;generator&#39;,
   &#39;plan_name&#39;: &#39;fly&#39;}),
 (&#39;descriptor&#39;,
  {&#39;run_start&#39;: &#39;63181aaa-eb7c-4d4c-a843-7a9221c120e7&#39;,
   &#39;time&#39;: 1589576343.7336648,
   &#39;data_keys&#39;: {},
   &#39;uid&#39;: &#39;f8cc69a7-fc8a-4b27-9f77-b8d9c17cf846&#39;,
   &#39;name&#39;: &#39;flyer&#39;,
   &#39;configuration&#39;: {},
   &#39;hints&#39;: {&#39;flyer&#39;: {&#39;fields&#39;: []}},
   &#39;object_keys&#39;: {&#39;flyer&#39;: []}}),
 (&#39;stop&#39;,
  {&#39;run_start&#39;: &#39;63181aaa-eb7c-4d4c-a843-7a9221c120e7&#39;,
   &#39;time&#39;: 1589576343.735018,
   &#39;uid&#39;: &#39;b7335315-0b0e-4a0b-9071-a7ccc3f73b34&#39;,
   &#39;exit_status&#39;: &#39;success&#39;,
   &#39;reason&#39;: &#39;&#39;,
   &#39;num_events&#39;: {&#39;flyer&#39;: 1}})]
</pre></div></div>
</div>
</div>
<div class="section" id="Flyer-:-a-starting-template">
<h3>Flyer : a starting template<a class="headerlink" href="#Flyer-:-a-starting-template" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">BareMinimumFlyer</span></code> is a good start to use a Flyer but we’ll need to add a few more things to make a good template. The first thing to do is to make the status objects known to any method of the class. We’ll prepend both of them with <code class="docutils literal notranslate"><span class="pre">self.</span></code> and describe in the code comments what is happening. In the constructor (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code>), we set both to <code class="docutils literal notranslate"><span class="pre">None</span></code>, the value we expect when not kicked off or <em>flying</em>, respectively. Since we <strong>need</strong> a constructor, we must remember to call the
constructor of the superclass as well or our <code class="docutils literal notranslate"><span class="pre">ophyd.Device</span></code> will not work correctly.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Our <em>controller</em> could take some time to signal that it is finished (seconds to minutes, at least). We need a way to detect this completion. We can do that either by polling the PV or by subscribing to a callback on the completion event. We’ll make that choice when we implement the actual activity. Here, intend to wait in a polling loop. Since the polling loop is an activity that does not return until the <em>controller</em> is done, we must do that waiting in a thread (consider an <cite>alternative
suggestion to use ``epics.ca.CAThread`</cite> &lt;<a class="reference external" href="https://github.com/NSLS-II/tutorial-docker/pull/7#discussion_r184905960">https://github.com/NSLS-II/tutorial-docker/pull/7#discussion_r184905960</a>&gt;`__) separate from that of the RunEngine. (We do not want to block the RunEngine thread so it is free to respond to other activities, such as data from other streams or the user inerface.) So, we run <code class="docutils literal notranslate"><span class="pre">my_activity()</span></code> in a separate thread that is called from <code class="docutils literal notranslate"><span class="pre">kickoff()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_activity</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>The basic outline of <code class="docutils literal notranslate"><span class="pre">my_activity()</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># tell the *controller* to do its work</span>
    <span class="c1"># once started, we notify by updating the status object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># wait for for it to tell us it is done</span>
    <span class="c1"># after the wait, we declare victory</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The waiting step will <em>block the thread</em> in which <code class="docutils literal notranslate"><span class="pre">my_activity()</span></code> is running but that’s OK since this is separate from the RunEngine’s thread.</p>
<p>Within <code class="docutils literal notranslate"><span class="pre">my_activity()</span></code>, we’ve left two comments starting with <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">TODO:</span></code> marking where we need to add code that will complete the specifics of our final project. Since this tutorial develops a starting template for that project (and others), we leave these comments as-is.</p>
<p>We’ve also added some diagnostic reporting (calls to <code class="docutils literal notranslate"><span class="pre">logger.info(...)</span></code>) to build out the next example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">MyFlyer</span><span class="p">(</span><span class="n">ophyd</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    starting template for a Flyer that we understand</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">my_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        start the &quot;fly scan&quot; here, could wait for completion</span>

<span class="sd">        It&#39;s OK to use blocking calls here</span>
<span class="sd">        since this is called in a separate thread</span>
<span class="sd">        from the Bluesky RunEngine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;activity()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leaving activity() - not complete&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TODO: do the activity here</span>

        <span class="c1"># once started, we notify by updating the status object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO: wait for completion</span>

        <span class="c1"># after the wait, we declare victory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;activity() complete. status = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start this Flyer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;kickoff()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_activity</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for flying to be complete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;complete()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No collection in progress&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;collect()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:{},</span> <span class="s1">&#39;timestamps&#39;</span><span class="p">:{},</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">describe_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describe details for ``collect()`` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;describe_collect()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{}}</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ifly</span> <span class="o">=</span> <span class="n">MyFlyer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ifly&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Diagnostics">
<h3>Diagnostics<a class="headerlink" href="#Diagnostics" title="Permalink to this headline">¶</a></h3>
<p>When building a <code class="docutils literal notranslate"><span class="pre">Flyer</span></code>, it is useful to have some diagnostics in place. Already, we have been using some of these, including printing interim messages via calls to <code class="docutils literal notranslate"><span class="pre">logger.info(...)</span></code>. Another useful diagnostic step is to call each of the methods individually to make sure they are acting as expected.</p>
<ol class="arabic">
<li><p>create an instance of the <code class="docutils literal notranslate"><span class="pre">Flyer</span></code></p>
<p>flyer = MyFlyer(name=“flyer”)</p>
</li>
<li><p>verify that <code class="docutils literal notranslate"><span class="pre">kickoff()</span></code> returns a status that is “Done”</p>
<p>status = flyer.kickoff() status.done</p>
</li>
<li><p>verify that <code class="docutils literal notranslate"><span class="pre">complete()</span></code> returns a status that is “Done”</p>
<p>status = flyer.complete() status.done</p>
</li>
<li><p>verify that <code class="docutils literal notranslate"><span class="pre">describe_collect()</span></code> returns a dictionary</p>
<p>d = flyer.describe_collect() d</p>
</li>
<li><p>verify that <code class="docutils literal notranslate"><span class="pre">collect()</span></code> returns a generator</p>
<p>g = flyer.collect() g</p>
</li>
<li><p>verify that generator is a list of data dictionaries</p>
<p>list(g)</p>
</li>
</ol>
<p>Apply some of those steps here (we’ll skip testing the <code class="docutils literal notranslate"><span class="pre">ifly.complete()</span></code> method when not flying since it raises a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> exception if data collection is not in progress):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ifly</span><span class="o">.</span><span class="n">describe_collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;ifly&#39;: {}}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="n">ifly</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;data&#39;: {}, &#39;timestamps&#39;: {}, &#39;time&#39;: 1589576343.8485878}]
</pre></div></div>
</div>
<p>Now, run this fly scan:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">RE</span><span class="p">(</span><span class="n">bluesky</span><span class="o">.</span><span class="n">plans</span><span class="o">.</span><span class="n">fly</span><span class="p">([</span><span class="n">ifly</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;3e4cd28c-48b2-471a-8d1f-49822e1552c7&#39;,)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stream_names</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;ifly&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;ifly&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
    </tr>
    <tr>
      <th>seq_num</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div></div>
</div>
<p>Still only two <code class="docutils literal notranslate"><span class="pre">documents</span></code> were emitted from the <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">documents</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;start&#39;,
  {&#39;uid&#39;: &#39;3e4cd28c-48b2-471a-8d1f-49822e1552c7&#39;,
   &#39;time&#39;: 1589576343.8559964,
   &#39;versions&#39;: {&#39;ophyd&#39;: &#39;1.5.1b1&#39;, &#39;bluesky&#39;: &#39;1.6.1&#39;},
   &#39;scan_id&#39;: 2,
   &#39;plan_type&#39;: &#39;generator&#39;,
   &#39;plan_name&#39;: &#39;fly&#39;}),
 (&#39;descriptor&#39;,
  {&#39;run_start&#39;: &#39;3e4cd28c-48b2-471a-8d1f-49822e1552c7&#39;,
   &#39;time&#39;: 1589576343.8581223,
   &#39;data_keys&#39;: {},
   &#39;uid&#39;: &#39;99551913-c339-41f9-9445-d31022ccbb8a&#39;,
   &#39;name&#39;: &#39;ifly&#39;,
   &#39;configuration&#39;: {},
   &#39;hints&#39;: {&#39;ifly&#39;: {&#39;fields&#39;: []}},
   &#39;object_keys&#39;: {&#39;ifly&#39;: []}}),
 (&#39;stop&#39;,
  {&#39;run_start&#39;: &#39;3e4cd28c-48b2-471a-8d1f-49822e1552c7&#39;,
   &#39;time&#39;: 1589576343.8587172,
   &#39;uid&#39;: &#39;62dc1856-140c-4da7-9851-abbc8937c216&#39;,
   &#39;exit_status&#39;: &#39;success&#39;,
   &#39;reason&#39;: &#39;&#39;,
   &#39;num_events&#39;: {&#39;ifly&#39;: 1}})]
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="First-working-Flyer---trivial-data">
<h2>First working Flyer - trivial data<a class="headerlink" href="#First-working-Flyer---trivial-data" title="Permalink to this headline">¶</a></h2>
<p>To collect data, we need to modify both the <code class="docutils literal notranslate"><span class="pre">collect()</span></code> <em>and</em> the <code class="docutils literal notranslate"><span class="pre">describe_collect()</span></code> methods. Bluesky needs to know what kind of data to expect from this Flyer, so that it can generate the correct <code class="docutils literal notranslate"><span class="pre">descriptor</span></code> document.</p>
<p>For the <em>most</em> trivial case, we’ll return a single number (<code class="docutils literal notranslate"><span class="pre">1.2345</span></code>) as the result of the first working Flyer.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">describe_collect()</span></code> method, we create a dictionary that describes the data to be collected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;fictional&quot;</span><span class="p">,</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
<span class="p">)</span>
<span class="k">return</span> <span class="p">{</span>
    <span class="s1">&#39;ifly&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">d</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then, in the <code class="docutils literal notranslate"><span class="pre">collect()</span></code> method, add the actual data collection code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.2345</span><span class="p">),</span>
    <span class="n">timestamps</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">yield</span> <span class="n">d</span>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">MyFlyer</span><span class="p">(</span><span class="n">ophyd</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    build a Flyer that we understand</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">my_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        start the &quot;fly scan&quot; here, could wait for completion</span>

<span class="sd">        It&#39;s OK to use blocking calls here</span>
<span class="sd">        since this is called in a separate thread</span>
<span class="sd">        from the Bluesky RunEngine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;activity()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leaving activity() - not complete&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TODO: do the activity here</span>

        <span class="c1"># once started, we notify by updating the status object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO: wait for completion</span>

        <span class="c1"># after the wait, we declare victory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;activity() complete. status = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start this Flyer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;kickoff()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_activity</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for flying to be complete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;complete()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No collection in progress&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span>

    <span class="k">def</span> <span class="nf">describe_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describe details for ``collect()`` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;describe_collect()&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;fictional&quot;</span><span class="p">,</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ifly&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">d</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start this Flyer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;collect()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.2345</span><span class="p">),</span>
            <span class="n">timestamps</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">d</span>
</pre></div>
</div>
</div>
<p>As before, create a new instance of the <em>revised</em> <code class="docutils literal notranslate"><span class="pre">MyFlyer</span></code> class.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ifly</span> <span class="o">=</span> <span class="n">MyFlyer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ifly&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output from describe_collect() : &#39;</span><span class="p">,</span> <span class="n">ifly</span><span class="o">.</span><span class="n">describe_collect</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;list output from collect() : &quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">ifly</span><span class="o">.</span><span class="n">collect</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
output from describe_collect() :  {&#39;ifly&#39;: {&#39;x&#39;: {&#39;source&#39;: &#39;fictional&#39;, &#39;dtype&#39;: &#39;number&#39;, &#39;shape&#39;: []}}}
list output from collect() :  [{&#39;time&#39;: 1589576343.943197, &#39;data&#39;: {&#39;x&#39;: 1.2345}, &#39;timestamps&#39;: {&#39;x&#39;: 1589576343.943197}}]
</pre></div></div>
</div>
<p>Running this flyer with the RunEngine seems anticlimactic but the lack of exceptions tells us that it ran and we get a UUID at the end.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">RE</span><span class="p">(</span><span class="n">bluesky</span><span class="o">.</span><span class="n">plans</span><span class="o">.</span><span class="n">fly</span><span class="p">([</span><span class="n">ifly</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/travis/virtualenv/python3.7.1/lib/python3.7/site-packages/event_model/__init__.py:170: UserWarning: The document type &#39;bulk_events&#39; has been deprecated in favor of &#39;event_page&#39;, whose structure is a transpose of &#39;bulk_events&#39;.
  &#34;The document type &#39;bulk_events&#39; has been deprecated in favor of &#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;9ff5668a-a91c-4ad8-bcd0-d0ffb92dba8f&#39;,)
</pre></div></div>
</div>
<p>We next query the last scan in the databroker and show a table of the stream from <code class="docutils literal notranslate"><span class="pre">collect()</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">h</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">stream_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>x</th>
    </tr>
    <tr>
      <th>seq_num</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2020-05-15 20:59:03.953200817</td>
      <td>1.2345</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Now, there are two more document types emitted: <code class="docutils literal notranslate"><span class="pre">descriptor</span></code> and <code class="docutils literal notranslate"><span class="pre">event</span></code>. Only one <code class="docutils literal notranslate"><span class="pre">event</span></code> since there is only one data point.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">documents</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;start&#39;,
  {&#39;uid&#39;: &#39;9ff5668a-a91c-4ad8-bcd0-d0ffb92dba8f&#39;,
   &#39;time&#39;: 1589576343.950689,
   &#39;versions&#39;: {&#39;ophyd&#39;: &#39;1.5.1b1&#39;, &#39;bluesky&#39;: &#39;1.6.1&#39;},
   &#39;scan_id&#39;: 3,
   &#39;plan_type&#39;: &#39;generator&#39;,
   &#39;plan_name&#39;: &#39;fly&#39;}),
 (&#39;descriptor&#39;,
  {&#39;run_start&#39;: &#39;9ff5668a-a91c-4ad8-bcd0-d0ffb92dba8f&#39;,
   &#39;time&#39;: 1589576343.952654,
   &#39;data_keys&#39;: {&#39;x&#39;: {&#39;source&#39;: &#39;fictional&#39;, &#39;dtype&#39;: &#39;number&#39;, &#39;shape&#39;: []}},
   &#39;uid&#39;: &#39;58f86ba8-a58a-43b6-bd5f-f4def24126b5&#39;,
   &#39;name&#39;: &#39;ifly&#39;,
   &#39;configuration&#39;: {},
   &#39;hints&#39;: {&#39;ifly&#39;: {&#39;fields&#39;: []}},
   &#39;object_keys&#39;: {&#39;ifly&#39;: [&#39;x&#39;]}}),
 (&#39;event&#39;,
  {&#39;descriptor&#39;: &#39;58f86ba8-a58a-43b6-bd5f-f4def24126b5&#39;,
   &#39;uid&#39;: &#39;482bc400-67c7-4fbc-9cae-1822e599912c&#39;,
   &#39;time&#39;: 1589576343.9532008,
   &#39;seq_num&#39;: 1,
   &#39;data&#39;: {&#39;x&#39;: 1.2345},
   &#39;timestamps&#39;: {&#39;x&#39;: 1589576343.9532008},
   &#39;filled&#39;: {}}),
 (&#39;stop&#39;,
  {&#39;run_start&#39;: &#39;9ff5668a-a91c-4ad8-bcd0-d0ffb92dba8f&#39;,
   &#39;time&#39;: 1589576343.9536974,
   &#39;uid&#39;: &#39;47118b17-3c7d-4914-9b37-042b14f89a92&#39;,
   &#39;exit_status&#39;: &#39;success&#39;,
   &#39;reason&#39;: &#39;&#39;,
   &#39;num_events&#39;: {&#39;ifly&#39;: 1}})]
</pre></div></div>
</div>
</div>
<div class="section" id="Flyer-that-“collects”-1-D-array-data">
<h2>Flyer that “collects” 1-D array data<a class="headerlink" href="#Flyer-that-“collects”-1-D-array-data" title="Permalink to this headline">¶</a></h2>
<p>We continue to expand the capabilities of our working example of a Flyer. Now, we wish to “collect” a 1-D array of data. We’ll manufacture that data ourselves to keep the code simple.</p>
<p>Here, we generate an array of 5 numbers, each representing the elapsed time (in seconds) since the scan started (in <code class="docutils literal notranslate"><span class="pre">kickoff()</span></code>). We record the start time with <code class="docutils literal notranslate"><span class="pre">self.t0</span> <span class="pre">=</span> <span class="pre">time.time()</span></code>. Also, <code class="docutils literal notranslate"><span class="pre">time.time()</span></code> is used to generate the timestamps in the data events. In a real case, we <em>might</em> get timestamps from the <em>controller</em> or we’d have to make it up ourselves, just like this example.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">MyFlyer</span><span class="p">(</span><span class="n">ophyd</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    a Flyer that we understand that reports 1-D array of data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">my_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        start the &quot;fly scan&quot; here, could wait for completion</span>

<span class="sd">        It&#39;s OK to use blocking calls here</span>
<span class="sd">        since this is called in a separate thread</span>
<span class="sd">        from the Bluesky RunEngine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;activity()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leaving activity() - not complete&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TODO: do the activity here</span>

        <span class="c1"># once started, we notify by updating the status object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO: wait for completion</span>

        <span class="c1"># after the wait, we declare victory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;activity() complete. status = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start this Flyer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;kickoff()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">DeviceStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_activity</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kickoff_status</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for flying to be complete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;complete()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No collection in progress&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span>

    <span class="k">def</span> <span class="nf">describe_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describe details for ``collect()`` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;describe_collect()&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;elapsed time, s&quot;</span><span class="p">,</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">d</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start this Flyer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;collect()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="c1"># data is elapsed time since kickoff()</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">),</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">d</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ifly</span> <span class="o">=</span> <span class="n">MyFlyer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ifly&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">ifly</span><span class="o">.</span><span class="n">describe_collect</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;ifly&#39;: {&#39;x&#39;: {&#39;source&#39;: &#39;elapsed time, s&#39;, &#39;dtype&#39;: &#39;number&#39;, &#39;shape&#39;: (1,)}}}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="n">ifly</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;time&#39;: 1589576344.040848,
  &#39;data&#39;: {&#39;x&#39;: 1589576344.040848},
  &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.040848}},
 {&#39;time&#39;: 1589576344.0408618,
  &#39;data&#39;: {&#39;x&#39;: 1589576344.0408618},
  &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0408618}},
 {&#39;time&#39;: 1589576344.0408638,
  &#39;data&#39;: {&#39;x&#39;: 1589576344.0408638},
  &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0408638}},
 {&#39;time&#39;: 1589576344.0408652,
  &#39;data&#39;: {&#39;x&#39;: 1589576344.0408652},
  &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0408652}},
 {&#39;time&#39;: 1589576344.0408666,
  &#39;data&#39;: {&#39;x&#39;: 1589576344.0408666},
  &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0408666}}]
</pre></div></div>
</div>
<p>Again, not much information from running this flyer, except that it succeeds and a uuid is returned.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">RE</span><span class="p">(</span><span class="n">bluesky</span><span class="o">.</span><span class="n">plans</span><span class="o">.</span><span class="n">fly</span><span class="p">([</span><span class="n">ifly</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/travis/virtualenv/python3.7.1/lib/python3.7/site-packages/event_model/__init__.py:170: UserWarning: The document type &#39;bulk_events&#39; has been deprecated in favor of &#39;event_page&#39;, whose structure is a transpose of &#39;bulk_events&#39;.
  &#34;The document type &#39;bulk_events&#39; has been deprecated in favor of &#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;66cf3ae9-0d92-4225-9486-da06e23a56d1&#39;,)
</pre></div></div>
</div>
<p>More information is obtained by asking the databroker about the most recent scan. Here’s the data table from our stream of data events. (The stream is named “ifly” as set from <code class="docutils literal notranslate"><span class="pre">self.name</span></code> in the <code class="docutils literal notranslate"><span class="pre">describe_collect()</span></code> method.) We’ll reference that last scan as <code class="docutils literal notranslate"><span class="pre">h</span></code> to reduce the amount of typing.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">h</span><span class="o">.</span><span class="n">stream_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;ifly&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">stream_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>x</th>
    </tr>
    <tr>
      <th>seq_num</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2020-05-15 20:59:04.051852226</td>
      <td>0.001406</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020-05-15 20:59:04.051870108</td>
      <td>0.001424</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2020-05-15 20:59:04.051879168</td>
      <td>0.001433</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2020-05-15 20:59:04.051887274</td>
      <td>0.001441</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2020-05-15 20:59:04.051894426</td>
      <td>0.001448</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We generated 5 data points, there are 5 <code class="docutils literal notranslate"><span class="pre">event</span></code> documents to match.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">documents</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;start&#39;,
  {&#39;uid&#39;: &#39;66cf3ae9-0d92-4225-9486-da06e23a56d1&#39;,
   &#39;time&#39;: 1589576344.049263,
   &#39;versions&#39;: {&#39;ophyd&#39;: &#39;1.5.1b1&#39;, &#39;bluesky&#39;: &#39;1.6.1&#39;},
   &#39;scan_id&#39;: 4,
   &#39;plan_type&#39;: &#39;generator&#39;,
   &#39;plan_name&#39;: &#39;fly&#39;}),
 (&#39;descriptor&#39;,
  {&#39;run_start&#39;: &#39;66cf3ae9-0d92-4225-9486-da06e23a56d1&#39;,
   &#39;time&#39;: 1589576344.0513694,
   &#39;data_keys&#39;: {&#39;x&#39;: {&#39;source&#39;: &#39;elapsed time, s&#39;,
     &#39;dtype&#39;: &#39;number&#39;,
     &#39;shape&#39;: [1]}},
   &#39;uid&#39;: &#39;4ec04421-9d77-4c31-a19a-cd959ff494c9&#39;,
   &#39;name&#39;: &#39;ifly&#39;,
   &#39;configuration&#39;: {},
   &#39;hints&#39;: {&#39;ifly&#39;: {&#39;fields&#39;: []}},
   &#39;object_keys&#39;: {&#39;ifly&#39;: [&#39;x&#39;]}}),
 (&#39;event&#39;,
  {&#39;descriptor&#39;: &#39;4ec04421-9d77-4c31-a19a-cd959ff494c9&#39;,
   &#39;uid&#39;: &#39;6865531e-914a-4dea-8245-e8698152aff1&#39;,
   &#39;time&#39;: 1589576344.0518522,
   &#39;seq_num&#39;: 1,
   &#39;data&#39;: {&#39;x&#39;: 0.001405954360961914},
   &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0518522},
   &#39;filled&#39;: {}}),
 (&#39;event&#39;,
  {&#39;descriptor&#39;: &#39;4ec04421-9d77-4c31-a19a-cd959ff494c9&#39;,
   &#39;uid&#39;: &#39;b326a01e-321d-499a-a29f-4f7862e08870&#39;,
   &#39;time&#39;: 1589576344.05187,
   &#39;seq_num&#39;: 2,
   &#39;data&#39;: {&#39;x&#39;: 0.0014238357543945312},
   &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.05187},
   &#39;filled&#39;: {}}),
 (&#39;event&#39;,
  {&#39;descriptor&#39;: &#39;4ec04421-9d77-4c31-a19a-cd959ff494c9&#39;,
   &#39;uid&#39;: &#39;bb27efcb-3af9-472a-a704-797489e1fae3&#39;,
   &#39;time&#39;: 1589576344.0518792,
   &#39;seq_num&#39;: 3,
   &#39;data&#39;: {&#39;x&#39;: 0.0014328956604003906},
   &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0518792},
   &#39;filled&#39;: {}}),
 (&#39;event&#39;,
  {&#39;descriptor&#39;: &#39;4ec04421-9d77-4c31-a19a-cd959ff494c9&#39;,
   &#39;uid&#39;: &#39;fa0098ba-405e-4e28-b924-2657f794ad9a&#39;,
   &#39;time&#39;: 1589576344.0518873,
   &#39;seq_num&#39;: 4,
   &#39;data&#39;: {&#39;x&#39;: 0.0014410018920898438},
   &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0518873},
   &#39;filled&#39;: {}}),
 (&#39;event&#39;,
  {&#39;descriptor&#39;: &#39;4ec04421-9d77-4c31-a19a-cd959ff494c9&#39;,
   &#39;uid&#39;: &#39;a68f9c5f-c8fc-4dda-aff9-3406d33f82d1&#39;,
   &#39;time&#39;: 1589576344.0518944,
   &#39;seq_num&#39;: 5,
   &#39;data&#39;: {&#39;x&#39;: 0.0014481544494628906},
   &#39;timestamps&#39;: {&#39;x&#39;: 1589576344.0518944},
   &#39;filled&#39;: {}}),
 (&#39;stop&#39;,
  {&#39;run_start&#39;: &#39;66cf3ae9-0d92-4225-9486-da06e23a56d1&#39;,
   &#39;time&#39;: 1589576344.0524101,
   &#39;uid&#39;: &#39;965486fd-c63a-4017-8838-c2c3f51e3bcc&#39;,
   &#39;exit_status&#39;: &#39;success&#39;,
   &#39;reason&#39;: &#39;&#39;,
   &#39;num_events&#39;: {&#39;ifly&#39;: 5}})]
</pre></div></div>
</div>
</div>
<div class="section" id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Permalink to this headline">¶</a></h2>
<p>Now you have seen the basic steps in creating a <code class="docutils literal notranslate"><span class="pre">Flyer</span></code>. You have also been shown a few diagnostic tools to help you investigate your code development.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Process Tabular Data with Pandas.html" class="btn btn-neutral float-right" title="Process Tabular Data with Pandas" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Epics Signal.html" class="btn btn-neutral float-left" title="Epics Signal" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Bluesky Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>