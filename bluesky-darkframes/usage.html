

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Usage &mdash; Bluesky Darkframes 0.post29+gf99f2b1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script type="text/javascript" src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reference" href="reference.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Bluesky Darkframes
          

          
          </a>

          
            
            
              <div class="version">
                0.post29+gf99f2b1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-user-s-perspective">The User’s Perspective</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initial-configuration">Initial Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acquire-and-access-data">Acquire and Access Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#export-subtracted-images">Export Subtracted Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#export-saved-data">Export saved data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#export-data-during-acquisition-streaming">Export data during acquisition (streaming)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-history.html">Release History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Bluesky Darkframes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Usage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-user-s-perspective">
<h2>The User’s Perspective<a class="headerlink" href="#the-user-s-perspective" title="Permalink to this headline">¶</a></h2>
<p>The user executes plans with the RunEngine is the usual way, with no extra
syntax. An Event stream named ‘dark’ is added to every Run automatically.
If desired subtracted frames can be exported to files or a database.</p>
</div>
<div class="section" id="initial-configuration">
<h2>Initial Configuration<a class="headerlink" href="#initial-configuration" title="Permalink to this headline">¶</a></h2>
<p>We need to know:</p>
<ol class="arabic simple">
<li><p>How do you take a dark frame? Specifically…. What’s the relevant shutter?
How do you close it? (Some think “0” is closed; others think “1” is closed;
still others need a multi-step dance to open or close.) What’s the relevant
detector?</p></li>
<li><p>What are the rules for when to take a fresh dark frame and when to reuse one
that has already been taken?</p></li>
<li><p>If you would like to compute subtracted frames on the fly, where should the
results go?</p></li>
</ol>
<p>To address (1) define a bluesky plan that closes the shutter, takes an
acquistion, and reopens the shutter. The last two lines in this example use a
special mechanism, <a class="reference internal" href="reference.html#bluesky_darkframes.SnapshotDevice" title="bluesky_darkframes.SnapshotDevice"><code class="xref py py-class docutils literal notranslate"><span class="pre">bluesky_darkframes.SnapshotDevice</span></code></a>, to stash the
acquisition where it can potentially be reused. (Later on we’ll set the rules
for whether/how dark frames can be reused.)</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bluesky.plan_stubs</span> <span class="k">as</span> <span class="nn">bps</span>
<span class="kn">import</span> <span class="nn">bluesky_darkframes</span>

<span class="c1"># This is some simulated hardware for demo purposes.</span>
<span class="kn">from</span> <span class="nn">bluesky_darkframes.sim</span> <span class="k">import</span> <span class="n">Shutter</span><span class="p">,</span> <span class="n">DiffractionDetector</span>
<span class="n">det</span> <span class="o">=</span> <span class="n">DiffractionDetector</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;det&#39;</span><span class="p">)</span>
<span class="n">shutter</span> <span class="o">=</span> <span class="n">Shutter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;shutter&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dark_plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">shutter</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;darkframe-trigger&#39;</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s1">&#39;darkframe-trigger&#39;</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">shutter</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">)</span>
    <span class="n">snapshot</span> <span class="o">=</span> <span class="n">bluesky_darkframes</span><span class="o">.</span><span class="n">SnapshotDevice</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">snapshot</span>
</pre></div>
</div>
</div>
<p>This is boilerplate bluesky and databroker setup not specificially related to
dark-frames.</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky</span> <span class="k">import</span> <span class="n">RunEngine</span>
<span class="kn">from</span> <span class="nn">databroker</span> <span class="k">import</span> <span class="n">Broker</span>
<span class="kn">from</span> <span class="nn">ophyd.sim</span> <span class="k">import</span> <span class="n">NumpySeqHandler</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Broker</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="s1">&#39;NPY_SEQ&#39;</span><span class="p">,</span> <span class="n">NumpySeqHandler</span><span class="p">)</span>
<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">()</span>
<span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span>
</pre></div>
</div>
</div>
<p>Here we set the rules for when to take fresh dark frames, (2). Examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Always take a fresh dark frame at the beginning of each run.</span>
<span class="n">dark_frame_preprocessor</span> <span class="o">=</span> <span class="n">bluesky_darkframes</span><span class="o">.</span><span class="n">DarkFramePreprocessor</span><span class="p">(</span>
    <span class="n">dark_plan</span><span class="o">=</span><span class="n">dark_plan</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Take a dark frame if the last one we took is more than 30 seconds old.</span>
<span class="n">dark_frame_preprocessor</span> <span class="o">=</span> <span class="n">bluesky_darkframes</span><span class="o">.</span><span class="n">DarkFramePreprocessor</span><span class="p">(</span>
    <span class="n">dark_plan</span><span class="o">=</span><span class="n">dark_plan</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># Take a fresh dark frame if the last one we took *with this exposure time*</span>
<span class="c1"># is more than 30 seconds old.</span>
<span class="n">dark_frame_preprocessor</span> <span class="o">=</span> <span class="n">bluesky_darkframes</span><span class="o">.</span><span class="n">DarkFramePreprocessor</span><span class="p">(</span>
    <span class="n">dark_plan</span><span class="o">=</span><span class="n">dark_plan</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">locked_signals</span><span class="o">=</span><span class="p">[</span><span class="n">det</span><span class="o">.</span><span class="n">exposure_time</span><span class="p">])</span>

<span class="c1"># Always take a new dark frame if the exposure time was changed from the</span>
<span class="c1"># previous run, even if we took one with this exposure time on some earlier</span>
<span class="c1"># run. Also, re-take if the settings haven&#39;t changed but the last dark</span>
<span class="c1"># frame is older than 30 seconds.</span>
<span class="n">dark_frame_preprocessor</span> <span class="o">=</span> <span class="n">bluesky_darkframes</span><span class="o">.</span><span class="n">DarkFramePreprocessor</span><span class="p">(</span>
    <span class="n">dark_plan</span><span class="o">=</span><span class="n">dark_plan</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">locked_signals</span><span class="o">=</span><span class="p">[</span><span class="n">det</span><span class="o">.</span><span class="n">exposure_time</span><span class="p">],</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll pick one example and configure the RunEngine to apply it to all plans.
This means that any plan, including user-defined ones, will automatically have
dark frames included.</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dark_frame_preprocessor</span> <span class="o">=</span> <span class="n">bluesky_darkframes</span><span class="o">.</span><span class="n">DarkFramePreprocessor</span><span class="p">(</span>
    <span class="n">dark_plan</span><span class="o">=</span><span class="n">dark_plan</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">RE</span><span class="o">.</span><span class="n">preprocessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dark_frame_preprocessor</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="acquire-and-access-data">
<h2>Acquire and Access Data<a class="headerlink" href="#acquire-and-access-data" title="Permalink to this headline">¶</a></h2>
<p>Let’s take some data.</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="k">import</span> <span class="n">count</span>

<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;7edc4561-50ad-4e4c-866c-dfdb3f24df31&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<p>And now let’s access the data and plot the raw “light” frame, the dark frame,
and the difference between the two.</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">light</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s1">&#39;det_image&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dark</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s1">&#39;det_image&#39;</span><span class="p">,</span> <span class="n">stream_name</span><span class="o">=</span><span class="s1">&#39;dark&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Light&#39;</span><span class="p">,</span> <span class="s1">&#39;Dark&#39;</span><span class="p">,</span> <span class="s1">&#39;Subtracted&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">light</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">light</span> <span class="o">-</span> <span class="n">dark</span><span class="p">),</span> <span class="n">axes</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
   <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
   <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">);</span>
</pre></div>
</div>
<img alt="_images/usage_4_0.png" src="_images/usage_4_0.png" />
</div>
</div>
<div class="section" id="export-subtracted-images">
<h2>Export Subtracted Images<a class="headerlink" href="#export-subtracted-images" title="Permalink to this headline">¶</a></h2>
<p>In this example we’ll export the data to a TIFF series, but it could equally
well be written to any other storage format.</p>
<div class="section" id="export-saved-data">
<h3>Export saved data<a class="headerlink" href="#export-saved-data" title="Permalink to this headline">¶</a></h3>
<p>First we’ll define a convenience function.</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky_darkframes</span> <span class="k">import</span> <span class="n">DarkSubtraction</span>
<span class="kn">from</span> <span class="nn">suitcase.tiff_series</span> <span class="k">import</span> <span class="n">Serializer</span>

<span class="k">def</span> <span class="nf">export_subtracted_tiff_series</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">subtractor</span> <span class="o">=</span> <span class="n">DarkSubtraction</span><span class="p">(</span><span class="s1">&#39;det_image&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Serializer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">serializer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">documents</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">subtractor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
            <span class="n">serializer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>And now apply it to the data we just took.</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">export_subtracted_tiff_series</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;exported_files/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This exports the subtracted images (with ‘primary’ in the name) and the dark
frames (with ‘dark’) in the name, which makes it possible to reconstruct the
original if desired.</p>
<div class="docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls exported_files
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">7</span><span class="n">edc4561</span><span class="o">-</span><span class="mi">50</span><span class="n">ad</span><span class="o">-</span><span class="mf">4e4</span><span class="n">c</span><span class="o">-</span><span class="mi">866</span><span class="n">c</span><span class="o">-</span><span class="n">dfdb3f24df31</span><span class="o">-</span><span class="n">dark</span><span class="o">-</span><span class="n">det_image</span><span class="o">-</span><span class="mf">0.</span><span class="n">tiff</span>
<span class="mi">7</span><span class="n">edc4561</span><span class="o">-</span><span class="mi">50</span><span class="n">ad</span><span class="o">-</span><span class="mf">4e4</span><span class="n">c</span><span class="o">-</span><span class="mi">866</span><span class="n">c</span><span class="o">-</span><span class="n">dfdb3f24df31</span><span class="o">-</span><span class="n">primary</span><span class="o">-</span><span class="n">det_image</span><span class="o">-</span><span class="mf">0.</span><span class="n">tiff</span>
</pre></div>
</div>
</div>
<p>To customize the file name and other output options, see
<a class="reference internal" href="reference.html#suitcase.tiff_series.Serializer" title="suitcase.tiff_series.Serializer"><code class="xref py py-class docutils literal notranslate"><span class="pre">suitcase.tiff_series.Serializer</span></code></a>.</p>
</div>
<div class="section" id="export-data-during-acquisition-streaming">
<h3>Export data during acquisition (streaming)<a class="headerlink" href="#export-data-during-acquisition-streaming" title="Permalink to this headline">¶</a></h3>
<p>TO DO</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="reference.html" class="btn btn-neutral float-right" title="Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>